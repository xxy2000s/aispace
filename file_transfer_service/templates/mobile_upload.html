<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§»åŠ¨ç«¯æ–‡ä»¶ä¸Šä¼ </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* ç§»åŠ¨ç«¯ä¸Šä¼ é¡µé¢ç‰¹å®šæ ·å¼ */
        .mobile-upload-container {
            max-width: 100%;
            padding: 15px;
            margin: 0;
            border-radius: 0;
            min-height: 100vh;
        }
        
        .mobile-header {
            padding: 20px 15px;
            text-align: center;
        }
        
        .mobile-upload-area {
            border: 3px dashed #4facfe;
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            margin-bottom: 20px;
        }
        
        .mobile-upload-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .mobile-upload-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .mobile-progress-container {
            margin: 20px 0;
        }
        
        .mobile-file-list {
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .mobile-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="container mobile-upload-container">
        <div class="mobile-header">
            <h1>ğŸ“± æ‰‹æœºæ–‡ä»¶ä¸Šä¼ </h1>
            <p>é€‰æ‹©æ–‡ä»¶ä¸Šä¼ åˆ°ç”µè„‘</p>
            <button class="back-btn" onclick="goBack()">â† è¿”å›ä¸»é¡µé¢</button>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <h2>ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h2>
                
                <div class="mobile-upload-buttons">
                    <button class="mobile-upload-btn" id="mobileFileUploadBtn">
                        ğŸ“„ ä¸Šä¼ æ–‡ä»¶
                    </button>
                    <button class="mobile-upload-btn" id="mobileFolderUploadBtn">
                        ğŸ“ ä¸Šä¼ æ–‡ä»¶å¤¹
                    </button>
                </div>
                
                <div class="mobile-upload-area" id="mobileUploadArea">
                    <p>æˆ–æ‹–æ‹½/æ”¾ç½®æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                    <p class="small">(åœ¨æ‰‹æœºä¸Šå¯ç›´æ¥ç‚¹å‡»ä¸Šä¼ )</p>
                </div>
                
                <input type="file" id="mobileFileInput" multiple style="display: none;">
                <input type="file" id="mobileFolderInput" multiple webkitdirectory directory style="display: none;">
                
                <div class="mobile-progress-container" id="mobileProgressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="mobileProgressFill"></div>
                    </div>
                    <div class="progress-text" id="mobileProgressText">å‡†å¤‡ä¸Šä¼ ...</div>
                </div>
                
                <div class="mobile-file-list" id="mobileFileList" style="display: none;">
                    <h3>ğŸ“‹ å·²é€‰æ‹©æ–‡ä»¶</h3>
                    <div id="selectedFilesList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MobileUploadApp {
            constructor() {
                this.currentUploadId = null;
                this.selectedFiles = [];
                this.init();
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                const mobileFileInput = document.getElementById('mobileFileInput');
                const mobileFolderInput = document.getElementById('mobileFolderInput');
                const mobileUploadArea = document.getElementById('mobileUploadArea');

                // æ–‡ä»¶ä¸Šä¼ æŒ‰é’®
                document.getElementById('mobileFileUploadBtn').addEventListener('click', () => {
                    mobileFileInput.click();
                });

                // æ–‡ä»¶å¤¹ä¸Šä¼ æŒ‰é’®
                document.getElementById('mobileFolderUploadBtn').addEventListener('click', () => {
                    mobileFolderInput.click();
                });

                // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                mobileFileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files);
                });

                mobileFolderInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files, true);
                });

                // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
                mobileUploadArea.addEventListener('click', () => {
                    mobileFileInput.click();
                });

                // æ‹–æ‹½ä¸Šä¼ ç›¸å…³äº‹ä»¶
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    mobileUploadArea.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    mobileUploadArea.addEventListener(eventName, this.highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    mobileUploadArea.addEventListener(eventName, this.unhighlight, false);
                });

                mobileUploadArea.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    const isFolder = Array.from(files).some(file => 
                        file.webkitRelativePath && file.webkitRelativePath.includes('/')
                    );
                    this.handleFileSelect(files, isFolder);
                }, false);
            }

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            highlight(e) {
                document.getElementById('mobileUploadArea').classList.add('dragover');
            }

            unhighlight(e) {
                document.getElementById('mobileUploadArea').classList.remove('dragover');
            }

            handleFileSelect(files, isFolder = false) {
                if (files.length === 0) return;

                this.selectedFiles = Array.from(files);
                this.displaySelectedFiles();
                
                // è‡ªåŠ¨å¼€å§‹ä¸Šä¼ 
                this.startUpload(isFolder);
            }

            displaySelectedFiles() {
                const fileList = document.getElementById('selectedFilesList');
                const container = document.getElementById('mobileFileList');
                
                if (this.selectedFiles.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                let html = '';
                this.selectedFiles.forEach((file, index) => {
                    const size = this.formatFileSize(file.size);
                    html += `
                        <div class="mobile-file-item">
                            <span>${file.name}</span>
                            <span>${size}</span>
                        </div>
                    `;
                });

                fileList.innerHTML = html;
                container.style.display = 'block';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async startUpload(isFolder = false) {
                if (this.selectedFiles.length === 0) return;

                const formData = new FormData();
                
                // æ·»åŠ æ–‡ä»¶åˆ°FormData
                for (let file of this.selectedFiles) {
                    formData.append('file', file);
                }

                // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œæ·»åŠ æ–‡ä»¶å¤¹ç»“æ„ä¿¡æ¯
                if (isFolder) {
                    const folderStructure = this.buildFolderStructure(this.selectedFiles);
                    formData.append('folder_structure', JSON.stringify(folderStructure));
                }

                try {
                    this.showProgress();
                    this.currentUploadId = this.generateUploadId();
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateProgress(100, 'ä¸Šä¼ å®Œæˆï¼');
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        setTimeout(() => {
                            this.hideProgress();
                            alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼');
                            
                            // æ¸…ç©ºå·²é€‰æ–‡ä»¶
                            this.selectedFiles = [];
                            document.getElementById('mobileFileList').style.display = 'none';
                        }, 1000);
                    } else {
                        this.updateProgress(0, `ä¸Šä¼ å¤±è´¥: ${result.error}`);
                    }
                } catch (error) {
                    this.updateProgress(0, `ä¸Šä¼ å‡ºé”™: ${error.message}`);
                }
            }

            buildFolderStructure(files) {
                const structure = {};
                for (let file of files) {
                    if (file.webkitRelativePath) {
                        const parts = file.webkitRelativePath.split('/');
                        let current = structure;
                        for (let i = 0; i < parts.length - 1; i++) {
                            if (!current[parts[i]]) {
                                current[parts[i]] = {};
                            }
                            current = current[parts[i]];
                        }
                    }
                }
                
                // è·å–æ ¹æ–‡ä»¶å¤¹å
                const firstPath = files[0]?.webkitRelativePath;
                const rootFolder = firstPath ? firstPath.split('/')[0] : 'unknown_folder';
                
                return {
                    name: rootFolder,
                    structure: structure
                };
            }

            generateUploadId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            showProgress() {
                document.getElementById('mobileProgressContainer').style.display = 'block';
                document.getElementById('mobileProgressFill').style.width = '0%';
                document.getElementById('mobileProgressText').textContent = 'å‡†å¤‡ä¸Šä¼ ...';
            }

            hideProgress() {
                document.getElementById('mobileProgressContainer').style.display = 'none';
            }

            updateProgress(percentage, text) {
                document.getElementById('mobileProgressFill').style.width = percentage + '%';
                document.getElementById('mobileProgressText').textContent = text;
            }
        }

        // åˆå§‹åŒ–ç§»åŠ¨ç«¯ä¸Šä¼ åº”ç”¨
        const mobileApp = new MobileUploadApp();

        function goBack() {
            window.location.href = '/';
        }
        
        // æ£€æµ‹æ˜¯å¦ä»äºŒç»´ç è·³è½¬è€Œæ¥ï¼Œå¦‚æœæ˜¯åˆ™éšè—è¿”å›æŒ‰é’®
        window.addEventListener('load', function() {
            // æ£€æŸ¥URLå‚æ•°æˆ–å…¶ä»–æ¡ä»¶åˆ¤æ–­æ˜¯å¦ä¸ºæ‰«ç è®¿é—®
            const isFromQR = new URLSearchParams(window.location.search).get('from_qr');
            if (isFromQR) {
                const backBtn = document.querySelector('.back-btn');
                if (backBtn) {
                    backBtn.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>