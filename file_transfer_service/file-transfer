#!/bin/bash
# file-transfer - æ–‡ä»¶ä¼ è¾“æœåŠ¡ç®¡ç†å·¥å…·
# ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„æœåŠ¡ç®¡ç†è„šæœ¬ï¼Œæ”¯æŒå¯åŠ¨ã€åœæ­¢ã€ç›‘æ§æ–‡ä»¶ä¼ è¾“æœåŠ¡

set -e

# è®¾ç½®é¡¹ç›®ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# åŸºç¡€é…ç½®
SERVICE_NAME="file-transfer-service"
SERVICE_DISPLAY_NAME="æ–‡ä»¶ä¼ è¾“æœåŠ¡"
PID_FILE="/tmp/file-transfer/file-transfer.pid"
LOG_FILE="/tmp/file-transfer/file-transfer.log"
ERROR_LOG_FILE="/tmp/file-transfer/file-transfer-error.log"
CONFIG_FILE="/tmp/file-transfer/file-transfer-config.json"
HEALTH_CHECK_TIMEOUT=5
MAX_RESTART_ATTEMPTS=3
LOG_MAX_SIZE=10485760

# é»˜è®¤é…ç½®
DEFAULT_PORT=9988
DEFAULT_HOST="0.0.0.0"
DEFAULT_DEBUG=false

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;94m'
NC='\033[0m'

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}" >&2
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    log_info "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    
    if ! command -v python3 &> /dev/null; then
        log_error "Python3 æœªå®‰è£…"
        return 1
    fi
    
    if ! command -v pip3 &> /dev/null; then
        log_error "pip3 æœªå®‰è£…"
        return 1
    fi
    
    if ! python3 -c "import flask" &> /dev/null; then
        log_warning "Flask æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
        # å°è¯•å¤šç§å®‰è£…æ–¹å¼
        if pip3 install flask --user 2>/dev/null; then
            log_success "Flask å®‰è£…æˆåŠŸ"
        elif python3 -m pip install flask --user 2>/dev/null; then
            log_success "Flask å®‰è£…æˆåŠŸ"
        else
            log_warning "Flask å®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç°æœ‰ç¯å¢ƒ..."
        fi
    fi
    
    log_success "ä¾èµ–æ£€æŸ¥é€šè¿‡"
    return 0
}

# åˆ›å»ºå¿…è¦çš„ç›®å½•
create_directories() {
    mkdir -p "$(dirname "$PID_FILE")"
    mkdir -p "$(dirname "$LOG_FILE")"
    mkdir -p "$(dirname "$ERROR_LOG_FILE")"
    mkdir -p "uploads"
    mkdir -p "temp"
}

# ä¿å­˜æœåŠ¡é…ç½®
save_service_config() {
    local port=$1
    local host=$2
    local debug=$3
    
    cat > "$CONFIG_FILE" << EOF
{
    "port": $port,
    "host": "$host",
    "debug": $debug,
    "start_time": "$(date -Iseconds)",
    "pid_file": "$PID_FILE",
    "log_file": "$LOG_FILE"
}
EOF
}

# åŠ è½½æœåŠ¡é…ç½®
load_service_config() {
    if [ -f "$CONFIG_FILE" ]; then
        if command -v jq &> /dev/null; then
            CONFIG_PORT=$(jq -r '.port' "$CONFIG_FILE" 2>/dev/null || echo "$DEFAULT_PORT")
            CONFIG_HOST=$(jq -r '.host' "$CONFIG_FILE" 2>/dev/null || echo "$DEFAULT_HOST")
            CONFIG_DEBUG=$(jq -r '.debug' "$CONFIG_FILE" 2>/dev/null || echo "$DEFAULT_DEBUG")
        else
            CONFIG_PORT=$(grep -o '"port":[[:space:]]*[0-9]*' "$CONFIG_FILE" | cut -d':' -f2 | tr -d ' ' | head -1 || echo "$DEFAULT_PORT")
            CONFIG_HOST=$(grep -o '"host":"[^"]*"' "$CONFIG_FILE" | cut -d'"' -f4 | head -1 || echo "$DEFAULT_HOST")
            CONFIG_DEBUG=$(grep -o '"debug":[[:space:]]*true\|false' "$CONFIG_FILE" | cut -d':' -f2 | tr -d ' ' | head -1 || echo "$DEFAULT_DEBUG")
        fi
    else
        CONFIG_PORT=$DEFAULT_PORT
        CONFIG_HOST=$DEFAULT_HOST
        CONFIG_DEBUG=$DEFAULT_DEBUG
    fi
}

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¯ç”¨
check_port_available() {
    local port=$1
    if lsof -i :$port &> /dev/null; then
        return 1
    else
        return 0
    fi
}

# å¯»æ‰¾å¯ç”¨ç«¯å£
find_free_port() {
    local start_port=${1:-$DEFAULT_PORT}
    local max_attempts=100
    
    for ((port=start_port; port<start_port+max_attempts; port++)); do
        if check_port_available $port; then
            echo $port
            return 0
        fi
    done
    
    log_error "æ— æ³•æ‰¾åˆ°å¯ç”¨ç«¯å£ (å°è¯•èŒƒå›´: $start_port-$((start_port+max_attempts-1)))"
    return 1
}

# å¥åº·æ£€æŸ¥
health_check() {
    local port=$1
    local host=${2:-"localhost"}
    
    if [ ! -f "$PID_FILE" ]; then
        return 1
    fi
    
    local pid=$(cat "$PID_FILE")
    if ! ps -p "$pid" > /dev/null 2>&1; then
        return 1
    fi
    
    if command -v curl &> /dev/null; then
        if curl -s --max-time $HEALTH_CHECK_TIMEOUT "http://$host:$port/" > /dev/null 2>&1; then
            return 0
        fi
    elif command -v wget &> /dev/null; then
        if wget -q --timeout=$HEALTH_CHECK_TIMEOUT -O /dev/null "http://$host:$port/" 2>&1; then
            return 0
        fi
    else
        if check_port_available $port; then
            return 1
        else
            return 0
        fi
    fi
    
    return 1
}

# æ—¥å¿—è½®è½¬
rotate_logs() {
    if [ -f "$LOG_FILE" ] && [ $(stat -f%z "$LOG_FILE" 2>/dev/null || stat -c%s "$LOG_FILE" 2>/dev/null) -gt $LOG_MAX_SIZE ]; then
        log_info "æ‰§è¡Œæ—¥å¿—è½®è½¬..."
        mv "$LOG_FILE" "${LOG_FILE}.old"
        touch "$LOG_FILE"
        log_success "æ—¥å¿—è½®è½¬å®Œæˆ"
    fi
    
    if [ -f "$ERROR_LOG_FILE" ] && [ $(stat -f%z "$ERROR_LOG_FILE" 2>/dev/null || stat -c%s "$ERROR_LOG_FILE" 2>/dev/null) -gt $LOG_MAX_SIZE ]; then
        mv "$ERROR_LOG_FILE" "${ERROR_LOG_FILE}.old"
        touch "$ERROR_LOG_FILE"
    fi
}

# å¯åŠ¨æœåŠ¡
start_service() {
    local port=${1:-$DEFAULT_PORT}
    local host=${2:-$DEFAULT_HOST}
    local debug=${3:-$DEFAULT_DEBUG}
    
    log_info "å¯åŠ¨ $SERVICE_DISPLAY_NAME..."
    
    if ! check_dependencies; then
        log_error "ä¾èµ–æ£€æŸ¥å¤±è´¥ï¼Œæ— æ³•å¯åŠ¨æœåŠ¡"
        return 1
    fi
    
    create_directories
    
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            if health_check $port $host; then
                log_warning "$SERVICE_DISPLAY_NAME å·²åœ¨è¿è¡Œ (PID: $pid, ç«¯å£: $port)"
                show_service_info $port $host
                return 1
            else
                log_warning "PIDæ–‡ä»¶å­˜åœ¨ä½†æœåŠ¡æ— å“åº”ï¼Œæ¸…ç†ä¸­..."
                rm -f "$PID_FILE"
            fi
        else
            log_info "æ¸…ç†è¿‡æœŸçš„PIDæ–‡ä»¶..."
            rm -f "$PID_FILE"
        fi
    fi
    
    if ! check_port_available $port; then
        log_warning "ç«¯å£ $port å·²è¢«å ç”¨ï¼Œå¯»æ‰¾å¯ç”¨ç«¯å£..."
        local new_port=$(find_free_port $port)
        if [ $? -ne 0 ]; then
            return 1
        fi
        port=$new_port
        log_info "ä½¿ç”¨ç«¯å£: $port"
    fi
    
    save_service_config $port $host $debug
    rotate_logs
    
    log_info "å¯åŠ¨æœåŠ¡è¿›ç¨‹ (ç«¯å£: $port, ä¸»æœº: $host)..."
    
    local start_cmd="python3 app.py --port $port --host $host"
    if [ "$debug" = true ]; then
        start_cmd="$start_cmd --debug"
    fi
    
    if command -v nohup &> /dev/null; then
        nohup $start_cmd > "$LOG_FILE" 2> "$ERROR_LOG_FILE" &
    else
        $start_cmd > "$LOG_FILE" 2> "$ERROR_LOG_FILE" &
    fi
    
    local pid=$!
    echo $pid > "$PID_FILE"
    
    log_info "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
    local wait_count=0
    local max_wait=30
    
    while [ $wait_count -lt $max_wait ]; do
        if health_check $port $host; then
            log_success "$SERVICE_DISPLAY_NAME å¯åŠ¨æˆåŠŸ"
            show_service_info $port $host
            return 0
        fi
        sleep 1
        ((wait_count++))
    done
    
    log_error "æœåŠ¡å¯åŠ¨è¶…æ—¶"
    if [ -f "$ERROR_LOG_FILE" ]; then
        log_error "é”™è¯¯æ—¥å¿—:"
        tail -10 "$ERROR_LOG_FILE"
    fi
    rm -f "$PID_FILE"
    return 1
}

# æ˜¾ç¤ºæœåŠ¡ä¿¡æ¯
show_service_info() {
    local port=$1
    local host=$2
    
    echo ""
    log_success "$SERVICE_DISPLAY_NAME è¿è¡Œä¿¡æ¯:"
    echo "  PID: $(cat "$PID_FILE")"
    echo "  ç«¯å£: $port"
    echo "  ä¸»æœº: $host"
    echo "  è®¿é—®åœ°å€: http://localhost:$port"
    
    if command -v ip &> /dev/null; then
        local ip_addr=$(ip route get 1.1.1.1 2>/dev/null | grep -oP 'src \K\S+' | head -1)
    elif command -v ifconfig &> /dev/null; then
        local ip_addr=$(ifconfig | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1)
    else
        local ip_addr="localhost"
    fi
    
    if [ -n "$ip_addr" ] && [ "$ip_addr" != "localhost" ]; then
        echo "  ç½‘ç»œè®¿é—®: http://$ip_addr:$port"
    fi
    
    echo "  æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    echo "  é”™è¯¯æ—¥å¿—: $ERROR_LOG_FILE"
    echo "  PIDæ–‡ä»¶: $PID_FILE"
    echo "  é…ç½®æ–‡ä»¶: $CONFIG_FILE"
    echo ""
}

# åœæ­¢æœåŠ¡
stop_service() {
    log_info "åœæ­¢ $SERVICE_DISPLAY_NAME..."
    
    if [ ! -f "$PID_FILE" ]; then
        log_warning "$SERVICE_DISPLAY_NAME æœªè¿è¡Œ"
        return 1
    fi
    
    local pid=$(cat "$PID_FILE")
    
    if ! ps -p "$pid" > /dev/null 2>&1; then
        log_warning "æœåŠ¡è¿›ç¨‹ä¸å­˜åœ¨ (PID: $pid)"
        rm -f "$PID_FILE"
        return 1
    fi
    
    log_info "å‘é€åœæ­¢ä¿¡å· (PID: $pid)..."
    kill -TERM "$pid" 2>/dev/null || true
    
    local wait_count=0
    local max_wait=15
    while [ $wait_count -lt $max_wait ] && ps -p "$pid" > /dev/null 2>&1; do
        sleep 1
        ((wait_count++))
    done
    
    if ps -p "$pid" > /dev/null 2>&1; then
        log_warning "è¿›ç¨‹æœªå“åº”ï¼Œå¼ºåˆ¶ç»ˆæ­¢..."
        kill -9 "$pid" 2>/dev/null || true
        sleep 2
    fi
    
    rm -f "$PID_FILE"
    
    if ps -p "$pid" > /dev/null 2>&1; then
        log_error "æ— æ³•åœæ­¢æœåŠ¡ (PID: $pid)"
        return 1
    else
        log_success "$SERVICE_DISPLAY_NAME å·²åœæ­¢"
        return 0
    fi
}

# é‡å¯æœåŠ¡
restart_service() {
    log_info "é‡å¯ $SERVICE_DISPLAY_NAME..."
    
    load_service_config
    
    if stop_service; then
        sleep 3
    fi
    
    start_service $CONFIG_PORT $CONFIG_HOST $CONFIG_DEBUG
}

# æœåŠ¡çŠ¶æ€æ£€æŸ¥
status_service() {
    if [ ! -f "$PID_FILE" ]; then
        log_error "$SERVICE_DISPLAY_NAME æœªè¿è¡Œ"
        return 1
    fi
    
    local pid=$(cat "$PID_FILE")
    
    if ! ps -p "$pid" > /dev/null 2>&1; then
        log_error "PIDæ–‡ä»¶å­˜åœ¨ä½†è¿›ç¨‹ä¸å­˜åœ¨ (PID: $pid)"
        rm -f "$PID_FILE"
        return 1
    fi
    
    load_service_config
    
    if health_check $CONFIG_PORT $CONFIG_HOST; then
        log_success "$SERVICE_DISPLAY_NAME æ­£åœ¨è¿è¡Œä¸”å“åº”æ­£å¸¸"
        show_service_info $CONFIG_PORT $CONFIG_HOST
        return 0
    else
        log_error "$SERVICE_DISPLAY_NAME è¿›ç¨‹å­˜åœ¨ä½†æœåŠ¡æ— å“åº”"
        log_info "PID: $pid"
        if [ -f "$ERROR_LOG_FILE" ]; then
            log_warning "æœ€è¿‘çš„é”™è¯¯ä¿¡æ¯:"
            tail -5 "$ERROR_LOG_FILE"
        fi
        return 1
    fi
}

# ç›‘æ§æœåŠ¡
monitor_service() {
    log_info "ç›‘æ§ $SERVICE_DISPLAY_NAME (æŒ‰ Ctrl+C åœæ­¢)..."
    
    load_service_config
    
    while true; do
        echo "==================== $(date) ===================="
        if status_service > /dev/null 2>&1; then
            echo "âœ… æœåŠ¡çŠ¶æ€: æ­£å¸¸è¿è¡Œ"
            echo "ğŸŒ ç«¯å£: $CONFIG_PORT"
        else
            echo "âŒ æœåŠ¡çŠ¶æ€: å¼‚å¸¸"
            local restart_count=0
            while [ $restart_count -lt $MAX_RESTART_ATTEMPTS ]; do
                log_warning "å°è¯•é‡å¯æœåŠ¡... ($((restart_count+1))/$MAX_RESTART_ATTEMPTS)"
                if start_service $CONFIG_PORT $CONFIG_HOST $CONFIG_DEBUG; then
                    log_success "æœåŠ¡é‡å¯æˆåŠŸ"
                    break
                fi
                ((restart_count++))
                sleep 5
            done
            
            if [ $restart_count -ge $MAX_RESTART_ATTEMPTS ]; then
                log_error "è¾¾åˆ°æœ€å¤§é‡å¯æ¬¡æ•°ï¼Œç›‘æ§åœæ­¢"
                return 1
            fi
        fi
        sleep 30
    done
}

# æŸ¥çœ‹æ—¥å¿—
view_logs() {
    local log_type=${1:-"both"}
    
    case $log_type in
        "access"|"stdout")
            if [ ! -f "$LOG_FILE" ]; then
                log_error "è®¿é—®æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $LOG_FILE"
                return 1
            fi
            log_info "æŸ¥çœ‹è®¿é—®æ—¥å¿— (Ctrl+C é€€å‡º):"
            tail -f "$LOG_FILE"
            ;;
        "error"|"stderr")
            if [ ! -f "$ERROR_LOG_FILE" ]; then
                log_error "é”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $ERROR_LOG_FILE"
                return 1
            fi
            log_info "æŸ¥çœ‹é”™è¯¯æ—¥å¿— (Ctrl+C é€€å‡º):"
            tail -f "$ERROR_LOG_FILE"
            ;;
        "both"|*)
            log_info "åŒæ—¶æŸ¥çœ‹è®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿— (Ctrl+C é€€å‡º):"
            if [ -f "$LOG_FILE" ] && [ -f "$ERROR_LOG_FILE" ]; then
                tail -f "$LOG_FILE" "$ERROR_LOG_FILE"
            elif [ -f "$LOG_FILE" ]; then
                tail -f "$LOG_FILE"
            elif [ -f "$ERROR_LOG_FILE" ]; then
                tail -f "$ERROR_LOG_FILE"
            else
                log_error "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
                return 1
            fi
            ;;
    esac
}

# æŸ¥çœ‹æœ€åNè¡Œæ—¥å¿—
tail_logs() {
    local lines=${1:-20}
    local log_type=${2:-"both"}
    
    case $log_type in
        "access"|"stdout")
            if [ -f "$LOG_FILE" ]; then
                log_info "æœ€è¿‘ $lines è¡Œè®¿é—®æ—¥å¿—:"
                tail -n "$lines" "$LOG_FILE"
            else
                log_error "è®¿é—®æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $LOG_FILE"
            fi
            ;;
        "error"|"stderr")
            if [ -f "$ERROR_LOG_FILE" ]; then
                log_info "æœ€è¿‘ $lines è¡Œé”™è¯¯æ—¥å¿—:"
                tail -n "$lines" "$ERROR_LOG_FILE"
            else
                log_error "é”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $ERROR_LOG_FILE"
            fi
            ;;
        "both"|*)
            log_info "æœ€è¿‘ $lines è¡Œæ—¥å¿—:"
            echo "--- è®¿é—®æ—¥å¿— ---"
            if [ -f "$LOG_FILE" ]; then
                tail -n "$lines" "$LOG_FILE"
            else
                echo "è®¿é—®æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            fi
            echo ""
            echo "--- é”™è¯¯æ—¥å¿— ---"
            if [ -f "$ERROR_LOG_FILE" ]; then
                tail -n "$lines" "$ERROR_LOG_FILE"
            else
                echo "é”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
            fi
            ;;
    esac
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "$SERVICE_DISPLAY_NAME ç®¡ç†å·¥å…·"
    echo ""
    echo "ç”¨æ³•: $0 {start|stop|restart|status|monitor|logs|tail} [å‚æ•°...]"
    echo ""
    echo "å‘½ä»¤è¯´æ˜:"
    echo "  start [ç«¯å£] [ä¸»æœº] [debug] - å¯åŠ¨æœåŠ¡"
    echo "  stop                      - åœæ­¢æœåŠ¡"
    echo "  restart                   - é‡å¯æœåŠ¡"
    echo "  status                    - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  monitor                   - ç›‘æ§æœåŠ¡çŠ¶æ€"
    echo "  logs [ç±»å‹]               - æŸ¥çœ‹å®æ—¶æ—¥å¿— (access|error|both)"
    echo "  tail [è¡Œæ•°] [ç±»å‹]        - æŸ¥çœ‹æœ€åNè¡Œæ—¥å¿—"
    echo ""
    echo "å‚æ•°è¯´æ˜:"
    echo "  ç«¯å£   - æœåŠ¡ç«¯å£ (é»˜è®¤: $DEFAULT_PORT)"
    echo "  ä¸»æœº   - ç›‘å¬åœ°å€ (é»˜è®¤: $DEFAULT_HOST)"
    echo "  debug  - è°ƒè¯•æ¨¡å¼ (true|false, é»˜è®¤: $DEFAULT_DEBUG)"
    echo "  ç±»å‹   - æ—¥å¿—ç±»å‹ (access|error|both, é»˜è®¤: both)"
    echo "  è¡Œæ•°   - æ˜¾ç¤ºæ—¥å¿—è¡Œæ•° (é»˜è®¤: 20)"
    echo ""
    echo "ç¯å¢ƒå˜é‡:"
    echo "  PORT=8081 $0 start        # ä½¿ç”¨8081ç«¯å£å¯åŠ¨"
    echo "  HOST=0.0.0.0 $0 start     # æŒ‡å®šç›‘å¬åœ°å€"
    echo "  DEBUG=true $0 start       # å¯ç”¨è°ƒè¯•æ¨¡å¼"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0 start                  # ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨"
    echo "  $0 start 9090            # ä½¿ç”¨9090ç«¯å£å¯åŠ¨"
    echo "  $0 start 8080 0.0.0.0 true  # æŒ‡å®šå®Œæ•´å‚æ•°"
    echo "  PORT=8081 $0 start       # é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®š"
    echo "  $0 status                # æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  $0 logs                  # æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  $0 logs error            # åªçœ‹é”™è¯¯æ—¥å¿—"
    echo "  $0 tail 50               # æŸ¥çœ‹æœ€å50è¡Œæ—¥å¿—"
    echo "  $0 monitor               # å¯åŠ¨æœåŠ¡ç›‘æ§"
}

# ä¸»ç¨‹åºå…¥å£
main() {
    case "$1" in
        start)
            local port=${2:-${PORT:-$DEFAULT_PORT}}
            local host=${3:-${HOST:-$DEFAULT_HOST}}
            local debug=${4:-${DEBUG:-$DEFAULT_DEBUG}}
            start_service $port $host $debug
            ;;
        stop)
            stop_service
            ;;
        restart)
            restart_service
            ;;
        status)
            status_service
            ;;
        monitor)
            monitor_service
            ;;
        logs)
            local log_type=${2:-"both"}
            view_logs $log_type
            ;;
        tail)
            local lines=${2:-20}
            local log_type=${3:-"both"}
            tail_logs $lines $log_type
            ;;
        *)
            show_help
            exit 1
            ;;
    esac
}

# è„šæœ¬å…¥å£ç‚¹
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
