#!/bin/bash
# 全局文件传输服务启动脚本

# 函数定义
show_help() {
    echo "文件传输服务 - 全局启动脚本"
    echo ""
    echo "用法: file-transfer [选项] [项目路径]"
    echo ""
    echo "选项:"
    echo "  -p, --port PORT    指定服务端口 (默认: 8080)"
    echo "  --host HOST        指定监听地址 (默认: 0.0.0.0)"
    echo "  -d, --daemon       后台运行模式"
    echo "  -s, --stop         停止后台运行的服务"
    echo "  -k, --kill         强制停止所有相关进程"
    echo "  -h, --help         显示帮助信息"
    echo ""
    echo "环境变量:"
    echo "  FILE_TRANSFER_PATH    指定项目路径"
    echo "  FILE_TRANSFER_LOG     指定日志文件 (默认: /tmp/file_transfer.log)"
    echo ""
    echo "示例:"
    echo "  file-transfer                           # 前台运行"
    echo "  file-transfer --port 9090              # 指定端口"
    echo "  file-transfer --daemon                 # 后台运行"
    echo "  file-transfer --daemon --port 9090     # 后台运行指定端口"
    echo "  file-transfer --stop                   # 停止后台服务"
    echo "  file-transfer /path/to/project         # 指定项目路径"
    echo "  FILE_TRANSFER_PATH=/path/to/project file-transfer  # 使用环境变量"
}

# 默认值
PORT=8080
HOST="0.0.0.0"
DAEMON_MODE=false
STOP_SERVICE=false
FORCE_KILL=false
PROJECT_DIR=""

# 检查PID文件位置
PID_FILE="/tmp/file_transfer.pid"
LOG_FILE="${FILE_TRANSFER_LOG:-/tmp/file_transfer.log}"

# 解析命令行参数
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--port)
            PORT="$2"
            shift 2
            ;;
        --host)
            HOST="$2"
            shift 2
            ;;
        -d|--daemon)
            DAEMON_MODE=true
            shift
            ;;
        -s|--stop)
            STOP_SERVICE=true
            shift
            ;;
        -k|--kill)
            FORCE_KILL=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        -*)
            echo "未知参数: $1"
            echo "使用 file-transfer --help 查看帮助"
            exit 1
            ;;
        *)
            PROJECT_DIR="$1"
            shift
            ;;
    esac
done

# 检查是否需要停止服务
if [ "$STOP_SERVICE" = true ]; then
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            echo "🛑 停止服务 (PID: $PID)..."
            kill "$PID" 2>/dev/null
            sleep 1
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "⚠️  强制停止服务..."
                kill -9 "$PID" 2>/dev/null
            fi
            rm -f "$PID_FILE"
            echo "✅ 服务已停止"
        else
            echo "❌ 服务进程不存在"
            rm -f "$PID_FILE"
        fi
    else
        echo "❌ 服务未运行"
    fi
    exit 0
fi

if [ "$FORCE_KILL" = true ]; then
    echo "💥 强制停止所有文件传输服务进程..."
    pkill -f "python.*app\.py" 2>/dev/null
    rm -f "$PID_FILE"
    echo "✅ 所有相关进程已停止"
    exit 0
fi

# 查找项目目录
if [ -z "$PROJECT_DIR" ]; then
    if [ -n "$FILE_TRANSFER_PATH" ]; then
        PROJECT_DIR="$FILE_TRANSFER_PATH"
    else
        # 自动查找项目目录
        POSSIBLE_PATHS=(
            "$HOME/Projects/file_transfer_service"
            "$HOME/Desktop/file_transfer_service"
            "$HOME/file_transfer_service"
            "/opt/file_transfer_service"
            "/usr/local/file_transfer_service"
            "$(pwd)/file_transfer_service"
            "."
        )

        for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -n "$path" ] && [ -d "$path" ] && [ -f "$path/app.py" ]; then
                PROJECT_DIR="$path"
                break
            fi
        done
    fi
fi

if [ -z "$PROJECT_DIR" ] || [ ! -f "$PROJECT_DIR/app.py" ]; then
    echo "❌ 未找到文件传输服务项目"
    echo ""
    echo "💡 解决方案:"
    echo "   1. 将项目放在常见目录如 ~/Projects/file_transfer_service"
    echo "   2. 或设置环境变量 FILE_TRANSFER_PATH=/path/to/your/project"
    echo "   3. 或直接指定项目路径: file-transfer /path/to/project"
    echo ""
    exit 1
fi

# 检查PID文件，如果服务已在运行
if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "❌ 服务已在运行 (PID: $PID)"
        echo "💡 使用 'file-transfer --stop' 停止当前服务，或指定其他端口"
        exit 1
    else
        # 清理无效的PID文件
        rm -f "$PID_FILE"
    fi
fi

# 切换到项目目录
cd "$PROJECT_DIR" || exit 1

# 检查依赖
if ! python -c "import flask" >/dev/null 2>&1; then
    echo "📦 安装依赖..."
    pip install -r requirements.txt >/dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "❌ 依赖安装失败"
        exit 1
    fi
fi

# 启动服务
if [ "$DAEMON_MODE" = true ]; then
    echo "🚀 后台启动文件传输服务 (端口: $PORT)..."
    nohup python app.py --port "$PORT" --host "$HOST" > "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"
    
    sleep 2
    if [ -f "$PID_FILE" ] && ps -p $(cat "$PID_FILE") > /dev/null 2>&1; then
        echo "✅ 服务后台运行成功 (PID: $(cat "$PID_FILE"), 端口: $PORT)"
        echo "🌐 访问地址: http://localhost:$PORT"
        echo "📝 日志文件: $LOG_FILE"
        echo "💡 使用 'file-transfer --stop' 停止服务"
    else
        echo "❌ 服务启动失败"
        rm -f "$PID_FILE"
        exit 1
    fi
else
    echo "🚀 启动文件传输服务 (端口: $PORT)..."
    echo "🌐 访问地址: http://localhost:$PORT"
    echo "💡 按 Ctrl+C 停止服务"
    echo ""
    python app.py --port "$PORT" --host "$HOST"
fi